##### SCRIPT : shallowHRD_hg38 #####


args = commandArgs(trailingOnly=TRUE)

path_to_ratio_file = args[1]
inputPath = normalizePath(dirname(path_to_ratio_file))

NAMEEE_intermediary1 = gsub("\\", "/", normalizePath(path_to_ratio_file), fixed = TRUE) # for window path
NAMEEE_intermediary2 = sub("*/*.bam_ratio.txt", "", NAMEEE_intermediary1)

NAMEEE = sub(".*/", "", NAMEEE_intermediary2)

output_relative_Path = args[2]
outputPath = normalizePath(output_relative_Path)


path_to_cyto = args[3]
cytoFile = normalizePath(path_to_cyto)

continue_on_error <- function() { 
  paste() 
}
options(error=continue_on_error) 

cat("======================================================== \n")
cat("Sample : ", NAMEEE, "\n")
cat("======================================================== \n")


##### Cytoband_hg38 #####

cyt_Annot<-read.csv(cytoFile,header=T,fill=T)

cyt_Annot<-cyt_Annot[,1:6]
for(k in 2:dim(cyt_Annot)[[1]]){
  str1<-as.numeric(cyt_Annot[k-1,2:3])
  str2<-as.numeric(cyt_Annot[k,2:3])
  if(sum(abs(str1-str2))==0){cyt_Annot[k,1]<-0}
}

cyt_Annot[1:(dim(cyt_Annot)[[1]]-1),1]<-cyt_Annot[1:(dim(cyt_Annot)[[1]]-1),1]+cyt_Annot[2:dim(cyt_Annot)[[1]],1]
cyt_Annot[dim(cyt_Annot)[[1]],1]<-1
cyt_Annot<-cyt_Annot[-which(cyt_Annot[,1]==0),]
cyt_Annot[,1]<-cyt_Annot[,6]-cyt_Annot[,5]
cyt_Annot[,2]<-cyt_Annot[,2]+(cyt_Annot[,3]-1)/2

for(k in 2:dim(cyt_Annot)[[1]]){
  if(cyt_Annot[k,2]==cyt_Annot[k-1,2]){cyt_Annot[k,1]<-cyt_Annot[k,6]-cyt_Annot[k-1,5];cyt_Annot[k-1,1]<-0}
}

cyt_Annot<-cyt_Annot[-which(cyt_Annot[,1]==0),]
arm_len<-cyt_Annot[,1:2]
chr_len<-arm_len
chr_len[,2]<-trunc(chr_len[,2])
for(k in 2:dim(chr_len)[[1]]){
  if(chr_len[k,2]==chr_len[k-1,2]){chr_len[k,1]==chr_len[k-1,1]+chr_len[k,1]
    chr_len[k-1,1]<-0
  }
}
chr_len<-chr_len[-which(chr_len[,1]==0),]
chr_len<-chr_len[-dim(chr_len)[[1]],]
GG<-sum(chr_len[,1])
chr_p<-round(chr_len[,1]/GG,3)


##### LIBRARIES #####

library("ggpubr")
library("gridExtra")
library("DescTools")


##### FUNCTIONS #####
## Function Local minima ##

localMinima <- function(x) { 
  y <- diff(c(.Machine$integer.max, x)) < 0L 
  rle(y)$lengths                             
  y <- cumsum(rle(y)$lengths)                 
  y <- y[seq.int(1L, length(y), 2L)]         
  if (x[[1]] == x[[2]]) {                    
    y <- y[-1]
  }
  y                                          
}


## Function readSegmFile ##

readSegmFile<-function(segFileName){
  aa<-scan(segFileName,nlines=1,what="character",quiet = T)
  k<-1
  
  while((length(grep("#",aa))!=0)&&(grep("#",aa)==1)){
    aa<-scan(segFileName,skip=k,nlines=1,what="character",quiet = T)
    k<-k+1
  }
  
  tmp<-read.delim(segFileName,skip=k-1, header=T,sep="\t")
  tmp<-data.matrix(tmp)
  if(k==2){
    results<-getInfoSegm(scan(segFileName,nlines=1,what="character",quiet = T))
    homoConst<-results$homoConst
    sdH<-results$sdH	
    p_BAF<-results$p_BAF
    q_LRR<-results$q_LRR
    Delta<-results$Delta
  }else{homoConst<-1;sdH<-NA;p_BAF<-NA;q_LRR<-NA;Delta<-c(2,NA)}
  
  out<-list(tmp=tmp,homoConst=homoConst,sdH=sdH,p_BAF=p_BAF,q_LRR=q_LRR,Delta=Delta)
}


## getSegmentID : gather in the same name segment of the length  ##

getSegmentID<-function(THR,tmp,c_chr,c_cn,c_conf){
  
  tmp[,c_conf]<-0;tmp[1,c_conf]<-1
  
  for(k in 2:dim(tmp)[[1]]){
    
    if(tmp[k,c_chr]==tmp[k-1,c_chr] & abs(tmp[k,c_cn]-tmp[k-1,c_cn])<THR){
      
      tmp[k,c_conf]<-tmp[k-1,c_conf]
      
    }else{tmp[k,c_conf]<-tmp[k-1,c_conf]+1}
  } 
  
  out<-tmp
  
}


## shrinkReprTMP

shrinkReprTMP<-function(tmp,c_posS,c_posE,c_cn,c_conf){
  
  for(k in 1:(dim(tmp)[[1]]-1)){
    
    if(tmp[k,c_conf]==tmp[k+1,c_conf]){
      
      tmp[k+1,c_posS]<-tmp[k,c_posS]
      
      w<-c(tmp[k+1,c_posE]-tmp[k+1,c_posS],tmp[k,c_posE]-tmp[k,c_posS])
      
      tmp[k+1,c_cn]<-weighted.mean(c(tmp[k+1,c_cn],tmp[k,c_cn]),w)
      
      tmp[k,1]<-0
    }
  }
  
  tt<-which(tmp[,1]==0);if(length(tt)!=0){tmp<-tmp[-tt,]}
  out<-tmp
  
}


## Function getInfoSegm

getInfoSegm<-function(infoString){
  
  tt<-unlist(strsplit(infoString,";"))
  hh<-grep("homoConst=",tt)
  if(length(hh)==1){homoConst<-as.numeric(sub("homoConst=","",tt[hh]))}else{homoConst<-1}
  hh<-grep("sdH=",tt)
  if(length(hh)==1){sdH<-as.numeric(sub("sdH=","",tt[hh]))}else{sdH<-NA}
  
  hh<-grep("p=",tt)
  if(length(hh)==1){p_BAF<-as.numeric(sub("p=","",tt[hh]))}else{p_BAF<-NA}
  
  hh<-grep("q=",tt)
  if(length(hh)==1){q_LRR<-as.numeric(sub("q=","",tt[hh]))}else{q_LRR<-NA}
  
  hh<-grep("2LR=",tt)
  if(length(hh)==1){Delta<-as.numeric(sub("2LR=","",tt[hh]))}else{Delta<-NA}
  Delta<-c(2,Delta)
  
  
  if((is.na(homoConst))||(!is.numeric(homoConst))){homoConst<-1
  }else{if((homoConst<0.8)||(homoConst>1)){homoConst<-1}
  }
  if((is.na(sdH))||(!is.numeric(sdH))){sdH<-NA
  }else{if((sdH<0.05)||(sdH>1)){sdH<-NA}
  }
  
  out<-list(homoConst=homoConst,sdH=sdH,p_BAF=p_BAF,q_LRR=q_LRR,Delta=Delta)
  
}


## breakSmoothToLGA

breakSmoothToLGA<-function(THR,tmp,c_ind,c_chr,c_posS,c_posE,c_cn,c_CN,c_conf){
  
  
  tmp<-getSegmentID(THR=THR,tmp=tmp,c_chr=c_chr+1,c_cn=c_cn,c_conf=c_conf)
  tmp<-shrinkReprTMP(tmp=tmp,c_posS=c_posS,c_posE=c_posE,c_cn=c_cn,c_conf=c_conf)
  
  tmp[,c_ind]<-seq(1,dim(tmp)[[1]])
  
  BreaksSmall<-0
  
  FL<-T
  while(FL){
    
    tmp[,c_ind]<-seq(1,dim(tmp)[[1]])
    
    kk<-which(round((tmp[,c_posE]-tmp[,c_posS])/10^6,1)<3) # segments smaller than 3Mb
    
    if(length(kk)>0){
      
      kk<-kk[order((tmp[kk,c_posE]-tmp[kk,c_posS])/10^6)] 
      
      
      for(k in 1:length(kk)){
        
        if(kk[k]==1){                                        
          if(tmp[kk[k]+1,c_chr+1]==tmp[kk[k],c_chr+1]){      
            if(tmp[kk[k]+1,c_ind]!=0){                       
              tmp[kk[k],c_ind]<-0                               
            }
          }                          
        }
        
        else{
          if(kk[k]==dim(tmp)[[1]]){                                                
            if(tmp[kk[k]-1,c_chr+1]==tmp[kk[k],c_chr+1] & tmp[kk[k]-1,c_ind]!=0){    
              tmp[kk[k],c_ind]<-0}                                                 
          }
          else{
            
            if(tmp[kk[k]-1,c_chr+1]==tmp[kk[k]+1,c_chr+1] & tmp[kk[k]-1,c_ind]!=0 & tmp[kk[k]+1,c_ind]!=0){tmp[kk[k],1]<-0}
            
            if(tmp[kk[k]-1,c_chr+1]==tmp[kk[k],c_chr+1] & tmp[kk[k]+1,c_chr+1]!=tmp[kk[k],c_chr+1] & tmp[kk[k]-1,c_ind]!=0){tmp[kk[k],c_ind]<-0}
            
            if(tmp[kk[k]+1,c_chr+1]==tmp[kk[k],c_chr+1] & tmp[kk[k]-1,c_chr+1]!=tmp[kk[k],c_chr+1] & tmp[kk[k]+1,c_ind]!=0){tmp[kk[k],c_ind]<-0}
            
            if(tmp[kk[k]+1,c_chr+1]!=tmp[kk[k],c_chr+1] & tmp[kk[k]-1,c_chr+1]!=tmp[kk[k],c_chr+1]){tmp[kk[k],c_ind]<-0}
            
          }
        }
      } 
      
      tt<-which(tmp[,c_ind]==0) 
      
      if(length(tt)>0){tmp <- tmp[-tt,];BreaksSmall<-BreaksSmall+length(tt)} 
      
      for(k in 1:(dim(tmp)[[1]]-1)){ 
        
        if(round((tmp[k+1,c_posS]-tmp[k,c_posE])/10^6,1)<3){    
          
          if(tmp[k,c_chr+1]==tmp[k+1,c_chr+1] & abs(tmp[k,c_cn]-tmp[k+1,c_cn])<THR){ 
            
            tmp[k+1,c_posS]<-tmp[k,c_posS]        
            
            w<-c(tmp[k+1,c_posE]-tmp[k+1,c_posS],tmp[k,c_posE]-tmp[k,c_posS]) 
            
            tmp[k+1,c_cn]<-weighted.mean(c(tmp[k+1,c_cn],tmp[k,c_cn]),w) 
            
            tmp[k,c_ind]<-0                                              
            
          }
          
          
        }
      }
      
      tt<-which(tmp[,c_ind]==0);if(length(tt)>0){tmp<-tmp[-tt,]} 
      
      
    }else{FL<-F}  
  }
  
  
  
  tmp<-getSegmentID(THR=THR,tmp=tmp,c_chr=c_chr+1,c_cn=c_cn,c_conf=c_conf)
  tmp<-shrinkReprTMP(tmp=tmp,c_posS=c_posS,c_posE=c_posE,c_cn=c_cn,c_conf=c_conf)
  
  tmp[1,c_ind]<-BreaksSmall
  
  out<-tmp
  
  
}


## LGA_control

LGA_control<-function(THR,lenBIN,lenMB,tmp,c_ind,c_chr,c_posS,c_posE,c_cn,c_CN,c_conf){
  
  tmp[,c_ind]<-seq(1,dim(tmp)[[1]])
  
  
  WC<-tmp[,c_CN]*0
  
  j<-5
  
  for(k in 2:dim(tmp)[[1]]){
    
    if(tmp[k,c_chr+1]==tmp[k-1,c_chr+1] & round((tmp[k,c_posS]-tmp[k-1,c_posE])/10^6,1)<3){
      
      if(round((tmp[k,c_posE]-tmp[k,c_posS])/10^6,0)>=lenMB & round((tmp[k-1,c_posE]-tmp[k-1,c_posS])/10^6,0)>=lenMB){
        
        
        if(abs(tmp[k,c_cn]-tmp[k-1,c_cn])>THR*coefficient){WC[k]<-1}
        
      }
      
    }
  }
  
  
  out<-WC
  
  
}


##### Fast gathering #####

dataTable <- read.table(paste0(inputPath,"/",NAMEEE,".bam_ratio.txt"), header = TRUE)
dataTable = dataTable[,1:4]

dataTable = dataTable[which(!dataTable[,1] == "X"),] 
dataTable = dataTable[which(!dataTable[,1] == "Y"),] 

dataTable[,1] = as.numeric(as.character(dataTable[,1]))

dataTable = dataTable[order(dataTable[,1]),]

L = dim(dataTable)[1]

size_window = dataTable[2,2] - dataTable[1,2]

dataTable = cbind(1:L, dataTable[,1], dataTable[,2], dataTable[,2]+size_window-1, 
                  dataTable[,3], dataTable[,4]) 

dataTable = as.data.frame(dataTable)
colnames(dataTable) = c("feature", "chromosome", "start", "end", "ratio", "ratio_median")

dataTable = dataTable[which(!dataTable$ratio == -1),]
dataTable = dataTable[which(!dataTable$ratio_median == -1),]

# No log2 transformation
dataTable[,5] = log2(dataTable[,5])
dataTable[,6] = log2(dataTable[,6])

ratio <- data.frame(dataTable)

short_size_window = size_window/1000

X=ratio

ratio_file_tsv = ratio # save in the moment

X=X[,-1] # feature
X=X[,-4] 


## Remove spurious regions based on telomere and centromere from UCSC

X <- X[which(!(X[,1]==1 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==1 & X[,2]>=119940001 & X[,3]<=145700001)),] 
X <- X[which(!(X[,1]==1 & X[,2]>=248946422 & X[,3]<=248956422)),]

X <- X[which(!(X[,1]==2 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==2 & X[,2]>=90402511 & X[,3]<=91402511)),]
X <- X[which(!(X[,1]==2 & X[,2]>=242183529 & X[,3]<=242193529)),]

X <- X[which(!(X[,1]==3 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==3 & X[,2]>=198285559 & X[,3]<=198295559)),]

X <- X[which(!(X[,1]==4 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==4 & X[,2]>=190204555 & X[,3]<=190214555)),]

X <- X[which(!(X[,1]==5 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==5 & X[,2]>=181528259 & X[,3]<=181538259)),]

X <- X[which(!(X[,1]==6 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==6 & X[,2]>=170795979 & X[,3]<=170805979)),]

X <- X[which(!(X[,1]==7 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==7 & X[,2]>=62456779 & X[,3]<=62506779)),]
X <- X[which(!(X[,1]==7 & X[,2]>=159335973 & X[,3]<=159345973)),]

X <- X[which(!(X[,1]==8 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==8 & X[,2]>=145128636 & X[,3]<=145138636)),]

X <- X[which(!(X[,1]==9 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==9 & X[,2]>=45518558 & X[,3]<=60518558)),]
X <- X[which(!(X[,1]==9 & X[,2]>=138384717 & X[,3]<=138394717)),]

X <- X[which(!(X[,1]==10 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==10 & X[,2]>=133787422 & X[,3]<=133797422)),]

X <- X[which(!(X[,1]==11 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==11 & X[,2]>=50871348 & X[,3]<=51078348)),]
X <- X[which(!(X[,1]==11 & X[,2]>=135076622 & X[,3]<=135086622)),]

X <- X[which(!(X[,1]==12 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==12 & X[,2]>=133265309 & X[,3]<=133275309)),]

X <- X[which(!(X[,1]==13 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==13 & X[,2]>=18051248 & X[,3]<=18071248)),]
X <- X[which(!(X[,1]==13 & X[,2]>=114354328 & X[,3]<=114364328)),]

X <- X[which(!(X[,1]==14 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==14 & X[,2]>=107033718 & X[,3]<=107043718)),]

X <- X[which(!(X[,1]==15 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==15 & X[,2]>=101981189 & X[,3]<=101991189)),]

X <- X[which(!(X[,1]==16 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==16 & X[,2]>=38280682 & X[,3]<=46280682)),]
X <- X[which(!(X[,1]==16 & X[,2]>=90328345 & X[,3]<=90338345)),]

X <- X[which(!(X[,1]==17 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==17 & X[,2]>=83247441 & X[,3]<=83257441)),]

X <- X[which(!(X[,1]==18 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==18 & X[,2]>=80363285 & X[,3]<=80373285)),]

X <- X[which(!(X[,1]==19 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==19 & X[,2]>=24448980 & X[,3]<=24498980)),]
X <- X[which(!(X[,1]==19 & X[,2]>=27190874 & X[,3]<=27240874)),]
X <- X[which(!(X[,1]==19 & X[,2]>=58607616 & X[,3]<=58617616)),]

X <- X[which(!(X[,1]==20 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==20 & X[,2]>=64434167 & X[,3]<=64444167)),]

X <- X[which(!(X[,1]==21 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==21 & X[,2]>=10814560 & X[,3]<=10864560)),]
X <- X[which(!(X[,1]==21 & X[,2]>=46699983 & X[,3]<=46709983)),]

X <- X[which(!(X[,1]==22 & X[,2]>=0 & X[,3]<=10000)),]
X <- X[which(!(X[,1]==22 & X[,2]>=50808468 & X[,3]<=50818468)),]


## Add chromosome arm 

options(show.error.messages = FALSE)

X$chr_arm <- rep(0,nrow(X))
colnames(X) <- c("chr", "start", "end", "ratio_median", "chr_arm")
X=X[c("chr", "chr_arm", "start", "end", "ratio_median")]

X[,3]=as.numeric(as.character(X[,3])) 
X[,4]=as.numeric(as.character(X[,4])) 

tt <- X[,1] == 1 & X[,3] < 124000000 & X[,4] < 124000000
X[tt,2] = 1
tt <- X[,1] == 1 & X[,3] > 124000000 & X[,4] > 124000000
X[tt,2] = 2
tt <- X[,1] == 1 & X[,3] < 124000000 & X[,4] > 124000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 124000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 124000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])  
rownames(X) <- NULL 

tt <- X[,1] == 2 & X[,3] < 93900000 & X[,4] < 93900000
X[tt,2] = 1
tt <- X[,1] == 2 & X[,3] > 93900000 & X[,4] > 93900000
X[tt,2] = 2
tt <- X[,1] == 2 & X[,3] < 93900000 & X[,4] > 93900000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 93900000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 93900001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 3 & X[,3] < 90900000 & X[,4] < 90900000
X[tt,2] = 1
tt <- X[,1] == 3 & X[,3] > 90900000 & X[,4] > 90900000
X[tt,2] = 2
tt <- X[,1] == 3 & X[,3] < 90900000 & X[,4] > 90900000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 90900000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 90900001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 4 & X[,3] < 50000000 & X[,4] < 50000000
X[tt,2] = 1
tt <- X[,1] == 4 & X[,3] > 50000000 & X[,4] > 50000000
X[tt,2] = 2
tt <- X[,1] == 4 & X[,3] < 50000000 & X[,4] > 50000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 50000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 50000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 5 & X[,3] < 48800000 & X[,4] < 48800000
X[tt,2] = 1
tt <- X[,1] == 5 & X[,3] > 48800000 & X[,4] > 48800000
X[tt,2] = 2
tt <- X[,1] == 5 & X[,3] < 48800000 & X[,4] > 48800000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 48800000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 48800001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 6 & X[,3] < 59800000 & X[,4] < 59800000
X[tt,2] = 1
tt <- X[,1] == 6 & X[,3] > 59800000 & X[,4] > 59800000
X[tt,2] = 2
tt <- X[,1] == 6 & X[,3] < 59800000 & X[,4] > 59800000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 59800000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 59800001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 7 & X[,3] < 60100000 & X[,4] < 60100000
X[tt,2] = 1
tt <- X[,1] == 7 & X[,3] > 60100000 & X[,4] > 60100000
X[tt,2] = 2
tt <- X[,1] == 7 & X[,3] < 60100000 & X[,4] > 60100000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 60100000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 60100001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 8 & X[,3] < 45200000 & X[,4] < 45200000
X[tt,2] = 1
tt <- X[,1] == 8 & X[,3] > 45200000 & X[,4] > 45200000
X[tt,2] = 2
tt <- X[,1] == 8 & X[,3] < 45200000 & X[,4] > 45200000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 45200000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 45200001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 


tt <- X[,1] == 9 & X[,3] < 43000000 & X[,4] < 43000000
X[tt,2] = 1
tt <- X[,1] == 9 & X[,4] > 43000000 & X[,4] > 43000000
X[tt,2] = 2
tt <- X[,1] == 9 & X[,3] < 43000000 & X[,4] > 43000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 43000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 43000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 10 & X[,3] < 39800000 & X[,4] < 39800000
X[tt,2] = 1
tt <- X[,1] == 10 & X[,3] > 39800000 & X[,4] > 39800000
X[tt,2] = 2
tt <- X[,1] == 10 & X[,3] < 39800000 & X[,4] > 39800000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 39800000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 39800001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 11 & X[,3] < 53400000 & X[,4] < 53400000
X[tt,2] = 1
tt <- X[,1] == 11 & X[,3] > 53400000 & X[,4] > 53400000
X[tt,2] = 2
tt <- X[,1] == 11 & X[,3] < 53400000 & X[,4] > 53400000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 53400000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 53400001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 12 & X[,3] < 35500000 & X[,4] < 35500000
X[tt,2] = 1
tt <- X[,1] == 12 & X[,3] > 35500000 & X[,4] > 35500000
X[tt,2] = 2
tt <- X[,1] == 12 & X[,3] < 35500000 & X[,4] > 35500000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 35500000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 35500001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 13 & X[,3] < 17700000 & X[,4] < 17700000
X[tt,2] = 1
tt <- X[,1] == 13 & X[,3] > 17700000 & X[,4] > 17700000
X[tt,2] = 2
tt <- X[,1] == 13 & X[,3] < 17700000 & X[,4] > 17700000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 17700000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 17700001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 14 & X[,3] < 17200000 & X[,4] < 17200000
X[tt,2] = 1
tt <- X[,1] == 14 & X[,3] > 17200000 & X[,4] > 17200000
X[tt,2] = 2
tt <- X[,1] == 14 & X[,3] < 17200000 & X[,4] > 17200000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 17200000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 17200001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 15 & X[,3] < 19000000 & X[,4] < 19000000
X[tt,2] = 1
tt <- X[,1] == 15 & X[,3] > 19000000 & X[,4] > 19000000
X[tt,2] = 2
tt <- X[,1] == 15 & X[,3] < 19000000 & X[,4] > 19000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 19000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 19000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 16 & X[,3] < 36800000 & X[,4] < 36800000
X[tt,2] = 1
tt <- X[,1] == 16 & X[,3] > 36800000 & X[,4] > 36800000
X[tt,2] = 2
tt <- X[,1] == 16 & X[,3] < 36800000 & X[,4] > 36800000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 36800000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 36800001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 17 & X[,3] < 25100000 & X[,4] < 25100000
X[tt,2] = 1
tt <- X[,1] == 17 & X[,3] > 25100000 & X[,4] > 25100000
X[tt,2] = 2
tt <- X[,1] == 17 & X[,3] < 25100000 & X[,4] > 25100000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 25100000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 25100001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 18 & X[,3] < 18500000 & X[,4] < 18500000
X[tt,2] = 1
tt <- X[,1] == 18 & X[,3] > 18500000 & X[,4] > 18500000
X[tt,2] = 2
tt <- X[,1] == 18 & X[,3] < 18500000 & X[,4] > 18500000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 18500000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 17200001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 19 & X[,3] < 26200000 & X[,4] < 26200000
X[tt,2] = 1
tt <- X[,1] == 19 & X[,3] > 26200000 & X[,4] > 26200000
X[tt,2] = 2
tt <- X[,1] == 19 & X[,3] < 26200000 & X[,4] > 26200000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 26200000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 26200001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 20 & X[,3] < 28100000 & X[,4] < 28100000
X[tt,2] = 1
tt <- X[,1] == 20 & X[,3] > 28100000 & X[,4] > 28100000
X[tt,2] = 2
tt <- X[,1] == 20 & X[,3] < 28100000 & X[,4] > 28100000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 28100000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 28100001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 21 & X[,3] < 12000000 & X[,4] < 12000000
X[tt,2] = 1
tt <- X[,1] == 21 & X[,3] > 12000000 & X[,4] > 12000000
X[tt,2] = 2
tt <- X[,1] == 21 & X[,3] < 12000000 & X[,4] > 12000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 12000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 12000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

tt <- X[,1] == 22 & X[,3] < 15000000 & X[,4] < 15000000
X[tt,2] = 1
tt <- X[,1] == 22 & X[,3] > 15000000 & X[,4] > 15000000
X[tt,2] = 2
tt <- X[,1] == 22 & X[,3] < 15000000 & X[,4] > 15000000
X[tt,2] = 1
B = X[tt,4]
X[tt,4] = 15000000
X=rbind(X[(1:which(tt==TRUE)),], c(X[tt,1], 2, 15000001, B, X[tt,5]) , X[-(1:which(tt==TRUE)),])
rownames(X) <- NULL 

X[,2]<-X[,1]+(X[,2]-1)/2      

tt=which(X$ratio_median==-Inf)

if (length(tt) >= 1){
  X=X[-tt,]  
}

X=as.matrix(X)

L = dim(X)[1]
A = matrix(0, ncol=6, nrow=L)

i=1    
c=1    

while (i < L){
  if(X[i,2]==X[i+1,2]){             
    if (X[i,5]==X[i+1,5]){          
      n=1
      while (X[i,2]==X[i+n,2] & X[i,5]==X[i+n,5] & i+n < L){
        n=n+1
      }
      if(i+n == L){
        A[c,]=c(X[i,1], X[i,2], X[i,3], X[i+n,4], X[i,5], X[i+n,4]-X[i,3]+1) 
        i=i+n
        c=c+1
      }
      else{
        A[c,]=c(X[i,1], X[i,2], X[i,3], X[i+n-1,4], X[i,5], X[i+n-1,4]-X[i,3]+1) 
        i=i+n
        c=c+1
      }
    }
    else{
      A[c,]=c(X[i,1], X[i,2], X[i,3], X[i,4], X[i,5], X[i,4]-X[i,3]+1)
      i=i+1
      c=c+1
    }
  }
  else{
    A[c,]=c(X[i,1], X[i,2], X[i,3], X[i,4], X[i,5], X[i,4]-X[i,3]+1)
    i=i+1                                        
    c=c+1                         
  }  
}

A=subset(A, A[,1] != 0)
rownames(A) <- NULL 
colnames(A) <- c("chr", "chr_arm", "start", "end", "ratio_median", "size")


write.table(A, file = paste0(outputPath,"/",NAMEEE,"_ratio_median_gathered.txt"), sep = "\t", row.names = FALSE)

options(show.error.messages = TRUE)

cat("on going... \n")

##### Find Threshold #####

X = read.table(paste0(outputPath,"/",NAMEEE,"_ratio_median_gathered.txt"), sep = "\t", header = TRUE)

X = X[which(X[,6] > 2999999),]

X = X[which(X[,6] > ((quantile(X[,6])[[4]] - quantile(X[,6])[[2]])/2)),]   

L=dim(X)[1]
X=data.matrix(X)

test=c()
i=1
for (i in 1:L){
  v=i+1
  for (y in v:L-1){
    test = c(test, abs(X[i,5] - X[y,5]))}
}  

minx = localMinima(density(test)$y)[2]
Threshold = density(test)$x[minx]

test = as.data.frame(test)

ploty <- ggplot(test, aes(x = test)) + geom_density() +
  geom_vline(aes(xintercept = Threshold), color = "blue") + 
  ggtitle(paste("Density pairwise difference large segment")) + xlab("difference") +
  theme(plot.title = element_text(hjust = 0.5, size = 13),
        axis.text.x = element_text(size=15),
        axis.title.x = element_text(size=13),
        axis.text.y = element_text(size=15),
        axis.title.y = element_blank(),
        panel.background = element_blank())
ggsave(paste0(outputPath,"/",NAMEEE,"_THR",".jpeg"), plot = ploty, device = "jpeg", width = 20, height = 10)


##### Reading and initialisation #####

segFiles <- list.files(outputPath, pattern = paste0(NAMEEE, "_ratio_median_gathered.txt"),full.names=T)

nSample<-1

coefficient = 1.0

ColNamesTMP<-c("index", "chr","chr_arm","posStart", "posEnd", "ratio")

c_ind<-1; c_chr<-2;c_posS<-4; c_posE<-5; c_cn<-6; c_conf<-8

LLBB<-c(3,4,5,6,7,8,9,10,11)          # size LGA tested

TAB<-matrix(0,nSample,20)              # matrix to stock results 
rownames(TAB)<-seq(1:nSample)          
colnames(TAB)<-seq(1,20)               

colnames(TAB)[1:6]<-c("p_BAF","q_LRR","2copyLRR","DNA_ind","All_breaks","less3Mb_breaks")

ii<-1

rownames(TAB)[ii]<-"result"

results<-readSegmFile(segFileName=segFiles[ii])  
tmp<-results$tmp                                  

tmp <- cbind(seq(1,dim(tmp)[[1]]),tmp) 
colnames(tmp)[1]<-c("index")

tmp <- cbind(tmp,rep(0,nrow(tmp))) 
colnames(tmp)[8]<-c("level")

graphe_I_tab = tmp

tt<-which(tmp[,c_chr+1]>23.6)                            # exclusion chr24 and more   
if(length(tt)>0){tmp<-tmp[-tt,]}

tt<-which(tmp[,c_chr+1]==21)                             # exclusion short arm chr21
if(length(tt)>0){tmp<-tmp[-tt,]}

tt<-which(tmp[,c_chr+1]==22)                             # exclusion short arm chr22
if(length(tt)>0){tmp<-tmp[-tt,]}

graphe_II_tab = tmp

tmp[,7] = tmp[,5] - tmp[,4] + 1

tmp_3mb = tmp[which(tmp[,7] > 2999999),]   
cop_tmp = tmp_3mb                    
THR=Threshold

if (THR > 0.45){
  THR = 0.45}

if (THR < 0.025){
  THR = 0.025
}

level=1


##### Gather big segment (> 3Mb) #####

options(show.error.messages = FALSE)

while (dim(cop_tmp)[1] > 1){  
  
  line_largest_index = which.max(cop_tmp[,7])             # biggest segment
  largest_index = cop_tmp[line_largest_index,1]           # associated index
  ratio_largest = cop_tmp[line_largest_index,6]           # median_ratio segment
  ratio_largest = ratio_largest + 0.00001                 # avoid picking same value
  
  close_index = cop_tmp[which.min(abs(cop_tmp[,6] - ratio_largest)),1]
  closest_index = c(largest_index, close_index)
  
  ## Find all value that matches the two closest index fit with THR 
  
  L=dim(cop_tmp)[1]
  
  for (i in 1:L){
    validation = 0
    n = length(closest_index)
    for (g in 1:n){
      if (abs(cop_tmp[i,6] - cop_tmp[which((cop_tmp[,1]==closest_index[g])),6]) < THR){   
        validation = validation + 1}
    }
    if (validation == n){
      closest_index = c(closest_index, cop_tmp[i,1])}}
  
  closest_index = unique(closest_index)
  
  ##  Assign level based on the index of close segment in genome    
  
  n = length(closest_index)
  for (i in 1:n){
    tmp_3mb[which((tmp_3mb[,1] == closest_index[i])),8] = level
    cop_tmp <- cop_tmp[which(!(cop_tmp[,1]==closest_index[i])),]
  }
  dim(tmp_3mb)
  dim(cop_tmp)
  level = level + 1
} 

##  Gather with level

options(show.error.messages = TRUE)

L1 = dim(tmp_3mb)[1]

A = matrix(0, ncol=8, nrow=L1)

i=1
c=1   
while (i<L1+1){
  if (i==L1){
    A[c,]=c(tmp_3mb[i,1], tmp_3mb[i,2], tmp_3mb[i,3], tmp_3mb[i,4], tmp_3mb[i,5], tmp_3mb[i,6], tmp_3mb[i,5]-tmp_3mb[i,4]+1, tmp_3mb[i,8])    # segment pas sur deux lignes, a stocker seul 
    i=i+1
    c=c+1}
  else{
    if(tmp_3mb[i,3] == tmp_3mb[i+1,3]){                                           
      if (tmp_3mb[i,8] == tmp_3mb[i+1,8]){                                        
        n=1
        somme=tmp_3mb[i,6]
        while (tmp_3mb[i,8] == tmp_3mb[i+n,8] && tmp_3mb[i,3] == tmp_3mb[i+n,3]){
          somme = somme + tmp_3mb[i+n,6]
          n = n + 1
          if(i+n == L1+1){
            break}}
        A[c,]=c(tmp_3mb[i,1], tmp_3mb[i,2], tmp_3mb[i,3], tmp_3mb[i,4], tmp_3mb[i+n-1,5], (somme)/n, tmp_3mb[i+n-1,5]- tmp_3mb[i,4]+1, tmp_3mb[i,8])
        i=i+n
        c=c+1}
      else{                                            
        A[c,]=c(tmp_3mb[i,1], tmp_3mb[i,2], tmp_3mb[i,3], tmp_3mb[i,4], tmp_3mb[i,5], tmp_3mb[i,6], tmp_3mb[i,5]-tmp_3mb[i,4]+1, tmp_3mb[i,8])    # segment pas sur deux lignes, a stocker seul 
        i=i+1
        c=c+1}}
    else{                                              
      A[c,]=c(tmp_3mb[i,1], tmp_3mb[i,2], tmp_3mb[i,3], tmp_3mb[i,4], tmp_3mb[i,5], tmp_3mb[i,6], tmp_3mb[i,5]-tmp_3mb[i,4]+1, tmp_3mb[i,8])
      i=i+1                                                              
      c=c+1}
  }  
}

A=subset(A, A[,1] != 0)

rownames(A) <- NULL 
colnames(A) <- c("index", "chr", "chr_arm", "start", "end", "ratio_median", "size", "level")

tmp_3mb=A

graphe_III_tab = tmp_3mb 

##### Reput small segment & Smoothing to final segmentation #####

options(show.error.messages = FALSE)

tmp_0.1_3mb=tmp[which(tmp[,7] > 99999),]
tmp_0.1_3mb=tmp_0.1_3mb[which(tmp_0.1_3mb[,7] < 2999999),]  

L_3mb=dim(tmp_3mb)[1]
l_0.1_3mb=dim(tmp_0.1_3mb)[1]

values = unique(tmp_0.1_3mb[,3][!tmp_0.1_3mb[,3] %in% tmp_3mb[,3]])  
length=length(values)

for (missing_chr_arm in values){
  c=1
  L_3mb=dim(tmp_3mb)[1]
  while(c < L_3mb+1){
    if (missing_chr_arm > max(tmp_3mb[,3])){
      tmp_3mb=rbind(tmp_3mb, tmp_0.1_3mb[which(tmp_0.1_3mb[,3] == missing_chr_arm),])}
    else if (missing_chr_arm < tmp_3mb[c,3]){
      if (c==1){
        tmp_3mb=rbind(tmp_0.1_3mb[which(tmp_0.1_3mb[,3] == missing_chr_arm),] , tmp_3mb[1:L_3mb,])
        c=L_3mb+1}
      else{
        tmp_3mb=rbind(tmp_3mb[1:(c-1),], tmp_0.1_3mb[which(tmp_0.1_3mb[,3] == missing_chr_arm),] , tmp_3mb[c:L_3mb,])}
      c=L_3mb+1}
    else{
      c=c+1
    }
  }
}

for (missing_chr_arm in values){
  tmp_0.1_3mb <- tmp_0.1_3mb[which(!(tmp_0.1_3mb[,3]==missing_chr_arm)),]}

L_3mb=dim(tmp_3mb)[1]
l_0.1_3mb=dim(tmp_0.1_3mb)[1]

i=1
c=1

while (i < l_0.1_3mb + 1){          
  c=1                                                                            # reset 
  L_3mb=dim(tmp_3mb)[1]
  while (c < L_3mb+1){                                                            
    if (tmp_0.1_3mb[i,3] == tmp_3mb[c,3]){                                            
      if (tmp_0.1_3mb[i,5] < tmp_3mb[c,4]){                         ############### 1 - Before all segments chr_arm
        if (c==1){  
          if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) > THR){          # No gathering 
            tmp_3mb=rbind(c(tmp_0.1_3mb[i,1],tmp_0.1_3mb[i,2],tmp_0.1_3mb[i,3],tmp_0.1_3mb[i,4],tmp_0.1_3mb[i,5], 
                            tmp_0.1_3mb[i,6],tmp_0.1_3mb[i,5]-tmp_0.1_3mb[i,4]+1, tmp_0.1_3mb[i,8]) , tmp_3mb[c:L_3mb,])
            i=i+1
            c=L_3mb+1}
          else{                                                     # gathering
            tmp_3mb=rbind(c(tmp_0.1_3mb[i,1], tmp_0.1_3mb[i,2], tmp_0.1_3mb[i,3], tmp_0.1_3mb[i,4], tmp_3mb[c,5], 
                            tmp_3mb[c,6],tmp_3mb[c,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c,8]), tmp_3mb[(c):L_3mb,])
            i=i+1
            c=L_3mb+1}
        }
        else{
          if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) > THR){                     # no gathering
            tmp_3mb=rbind(tmp_3mb[1:(c-1),], c(tmp_0.1_3mb[i,1],tmp_0.1_3mb[i,2],tmp_0.1_3mb[i,3],tmp_0.1_3mb[i,4],tmp_0.1_3mb[i,5], 
                                               tmp_0.1_3mb[i,6],tmp_0.1_3mb[i,5]-tmp_0.1_3mb[i,4]+1, tmp_0.1_3mb[i,8]) , tmp_3mb[c:L_3mb,])
            i=i+1
            c=L_3mb+1}
          else{                                                                # gathering
            tmp_3mb=rbind(tmp_3mb[1:(c-1),], c(tmp_0.1_3mb[i,1], tmp_0.1_3mb[i,2], tmp_0.1_3mb[i,3], tmp_0.1_3mb[i,4], tmp_3mb[c,5], 
                                               tmp_3mb[c,6],tmp_3mb[c,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c,8]), tmp_3mb[(c+1):L_3mb,])
            i=i+1
            c=L_3mb+1}
        }
      }
      
      else if (tmp_0.1_3mb[i,4] >= tmp_3mb[c,4] && tmp_0.1_3mb[i,5] <= tmp_3mb[c,5]){    ########## 2 - Inside segments
        if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) > THR){
          if(c+1>L_3mb){          # after                          
            tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1],tmp_3mb[c,2] ,tmp_3mb[c,3], tmp_3mb[c,4], tmp_0.1_3mb[i,4]-1,tmp_3mb[c,6],tmp_0.1_3mb[i,4]-1-tmp_3mb[c,4]+1,tmp_3mb[c,8]) ,
                          tmp_0.1_3mb[i,] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3], tmp_0.1_3mb[i,5] +1 , tmp_3mb[c,5],tmp_3mb[c,6], tmp_3mb[c,5] - (tmp_0.1_3mb[i,5]+1) + 1,tmp_3mb[c,8]))
            i=i+1
            c=L_3mb+1}
          else{
            if (tmp_0.1_3mb[i,4] == tmp_3mb[c,4]){               # same beginning
              tmp_3mb=rbind(tmp_3mb[1:(c-1),] , tmp_0.1_3mb[i,] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3], tmp_0.1_3mb[i,5] +1 , tmp_3mb[c,5],tmp_3mb[c,6], tmp_3mb[c,5] - (tmp_0.1_3mb[i,5]+1) + 1,tmp_3mb[c,8]) ,
                            tmp_3mb[(c+1):L_3mb,])
              i=i+1
              c=L_3mb+1}
            else if (tmp_0.1_3mb[i,5] == tmp_3mb[c,5]) {         # same end
              tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3], tmp_3mb[i,4], tmp_0.1_3mb[c,4] - 1, tmp_3mb[c,6], tmp_0.1_3mb[c,4] - 1 - (tmp_3mb[i,4]) + 1,  tmp_3mb[c,8]), tmp_0.1_3mb[i,] , 
                            tmp_3mb[(c+1):L_3mb,])
              i=i+1
              c=L_3mb+1}
            else {               # in the middle
              tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1], tmp_3mb[c,2], tmp_3mb[c,3], tmp_3mb[c,4], tmp_0.1_3mb[i,4]-1, tmp_3mb[c,6], tmp_0.1_3mb[i,4]-1-tmp_3mb[c,4]+1,tmp_3mb[c,8]) ,
                            tmp_0.1_3mb[i,] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3], tmp_0.1_3mb[i,5] +1 , tmp_3mb[c,5],tmp_3mb[c,6], tmp_3mb[c,5] - (tmp_0.1_3mb[i,5]+1) + 1,tmp_3mb[c,8]) ,
                            tmp_3mb[(c+1):L_3mb,])
              i=i+1
              c=L_3mb+1}
          }}
        else{           # nothing to be done
          i=i+1
          c=L_3mb+1}
      }
      
      else if (tmp_0.1_3mb[i,4] >= tmp_3mb[c,5] && tmp_0.1_3mb[i,5] <= tmp_3mb[c+1,4] && tmp_3mb[c,3] == tmp_3mb[c+1,3]){     ########## 3 - between two segments same chr_arm
        if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) <= THR && abs(tmp_0.1_3mb[i,6] - tmp_3mb[c+1,6]) <= THR){       # two in range THR
          if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) <= abs(tmp_0.1_3mb[i,6] - tmp_3mb[c+1,6])){     # c closer
            tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1], tmp_3mb[c,2], tmp_3mb[c,3], tmp_3mb[c,4], tmp_0.1_3mb[i,5], tmp_3mb[c,6],
                                                tmp_0.1_3mb[i,5]-tmp_3mb[c,4]+1,tmp_3mb[c,8]) , tmp_3mb[(c+1):L_3mb,])  
            i=i+1
            c=L_3mb+1}
          else {                      # c+1 closer
            if (c+2 > L_3mb){
              tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_3mb[c+1,1], tmp_3mb[c+1,2], tmp_3mb[c+1,3], tmp_0.1_3mb[i,4], tmp_3mb[c+1,5], tmp_3mb[c+1,6],
                                              tmp_3mb[c+1,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c+1,8])) 
              i=i+1
              c=L_3mb+1}
            else{
              tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_3mb[c+1,1], tmp_3mb[c+1,2], tmp_3mb[c+1,3], tmp_0.1_3mb[i,4], tmp_3mb[c+1,5], tmp_3mb[c+1,6],
                                              tmp_3mb[c+1,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c+1,8]) , tmp_3mb[(c+2):L_3mb,])  
              i=i+1
              c=L_3mb+1}
          }
        }
        else if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) <= THR){                   # only c
          tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1], tmp_3mb[c,2], tmp_3mb[c,3], tmp_3mb[c,4], tmp_0.1_3mb[i,5], tmp_3mb[c,6],
                                              tmp_0.1_3mb[i,5]-tmp_3mb[c,4]+1,tmp_3mb[c,8]) , tmp_3mb[(c+1):L_3mb,])  
          i=i+1
          c=L_3mb+1}
        else if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c+1,6]) <= THR){                  # only c+1
          if (c+2 > L_3mb){
            tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_3mb[c+1,1], tmp_3mb[c+1,2], tmp_3mb[c+1,3], tmp_0.1_3mb[i,4], tmp_3mb[c+1,5], tmp_3mb[c+1,6],
                                            tmp_3mb[c+1,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c+1,8]))  
            i=i+1
            c=L_3mb+1}
          else{
            if (tmp_0.1_3mb[i+1,5] < tmp_3mb[c+1,4] && tmp_0.1_3mb[i+1,3] == tmp_3mb[c+1,3]){  # small segments afterward
              tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_0.1_3mb[i,1], tmp_0.1_3mb[i,2], tmp_0.1_3mb[i,3], tmp_0.1_3mb[i,4], tmp_0.1_3mb[i,5], tmp_0.1_3mb[i,6],
                                              tmp_0.1_3mb[i,5]-tmp_0.1_3mb[i,4]+1,tmp_0.1_3mb[i,8]) , tmp_3mb[(c+1):L_3mb,])  
              i=i+1
              c=L_3mb+1}
            else{
              tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_3mb[c+1,1], tmp_3mb[c+1,2], tmp_3mb[c+1,3], tmp_0.1_3mb[i,4], tmp_3mb[c+1,5], tmp_3mb[c+1,6],
                                              tmp_3mb[c+1,5]-tmp_0.1_3mb[i,4]+1,tmp_3mb[c+1,8]) , tmp_3mb[(c+2):L_3mb,])  
              i=i+1
              c=L_3mb+1}
          }
        }
        else{                                      
          tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_0.1_3mb[i,1],tmp_0.1_3mb[i,2],tmp_0.1_3mb[i,3],tmp_0.1_3mb[i,4],
                                          tmp_0.1_3mb[i,5],tmp_0.1_3mb[i,6],tmp_0.1_3mb[i,7],tmp_0.1_3mb[i,8]) , tmp_3mb[(c+1):L_3mb,])
          i=i+1
          c=L_3mb+1}
      }
      else if (tmp_0.1_3mb[i,4] >= tmp_3mb[c,5] && (tmp_3mb[c,3] != tmp_3mb[c+1,3] | is.null(tmp_3mb[c+1,3]))){     ############## 4 - after last segment chr_arm
        if (abs(tmp_0.1_3mb[i,6] - tmp_3mb[c,6]) <= THR){
          if (c+1 > L_3mb){
            tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3],tmp_3mb[c,4],
                                                tmp_0.1_3mb[i,5],tmp_3mb[c,6],tmp_0.1_3mb[i,5]-tmp_3mb[c,4]+1,tmp_3mb[c,8])) 
            i=i+1
            c=L_3mb+1}
          else{
            tmp_3mb=rbind(tmp_3mb[1:(c-1),] , c(tmp_3mb[c,1],tmp_3mb[c,2],tmp_3mb[c,3],tmp_3mb[c,4],
                                                tmp_0.1_3mb[i,5],tmp_3mb[c,6],tmp_0.1_3mb[i,5]-tmp_3mb[c,4]+1,tmp_3mb[c,8]) , tmp_3mb[(c+1):L_3mb,])
            i=i+1
            c=L_3mb+1}}
        else{
          if (c+1 > L_3mb){
            tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_0.1_3mb[i,1],tmp_0.1_3mb[i,2],tmp_0.1_3mb[i,3],tmp_0.1_3mb[i,4],
                                            tmp_0.1_3mb[i,5],tmp_0.1_3mb[i,6],tmp_0.1_3mb[i,7],tmp_0.1_3mb[i,8]))
            i=i+1
            c=L_3mb+1}
          else{
            tmp_3mb=rbind(tmp_3mb[1:c,] , c(tmp_0.1_3mb[i,1],tmp_0.1_3mb[i,2],tmp_0.1_3mb[i,3],tmp_0.1_3mb[i,4],
                                            tmp_0.1_3mb[i,5],tmp_0.1_3mb[i,6],tmp_0.1_3mb[i,7],tmp_0.1_3mb[i,8]) , tmp_3mb[(c+1):L_3mb,])
            i=i+1
            c=L_3mb+1}}}
      
      else {
        c=c+1
      }
    }    
    else{                                            
      c=c+1
    }
  }
}

options(show.error.messages = TRUE)

graphe_IV_tab = tmp_3mb

tmp_3mb<-breakSmoothToLGA(THR,tmp_3mb,c_ind=c_ind,c_chr=c_chr,c_posS=c_posS,c_posE=c_posE,c_cn=c_cn,c_conf=c_conf)

graphe_V_tab = tmp_3mb

cat("on going... \n")


## graphe representative of the final segmentation 

test_data_frame = as.data.frame(tmp_3mb)
colnames(test_data_frame) <- make.unique(names(test_data_frame))

test_ordered = test_data_frame[order(test_data_frame$ratio_median),]
test_ordered$num_line <- seq.int(nrow(test_ordered))

test_ploty_CN_level <- ggplot(test_ordered, aes(x = ratio_median, y = num_line)) + 
  geom_point(shape = 1, size = 1, color = "#0072B2", na.rm = TRUE) + geom_line() + ggtitle("Final segmentation diagnostic") + 
  xlab("ratio median") + xlim(-2.5,2.5) + 
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.text.x = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.background = element_blank())
suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_final_segmentation_visual",".jpeg"), plot = test_ploty_CN_level, device = "jpeg", width = 20, height = 10))


##### Call LGAs #####

LGAs_data_frame <- as.data.frame(matrix(0, ncol = 2, nrow = 9))
LGAs_data_frame[,1] = c(3:11)
colnames(LGAs_data_frame) <- c("Size_LGA", "Number_LGA")

for (i in (3:11)){
  WC<-LGA_control(THR,lenBIN=500,lenMB=i,tmp_3mb,c_ind=c_ind,c_chr=c_chr,c_posS=c_posS,c_posE=c_posE,c_cn=c_cn,c_conf=c_conf)
  LGAs_data_frame[i-2,2] = sum(WC[,1])}
write.table(LGAs_data_frame, file = paste0(outputPath,"/",NAMEEE,"_number_LGAs.txt"), sep = "\t", row.names = FALSE)


# For graphe 10Mb 

WC<-LGA_control(THR,lenBIN=500,lenMB=10,tmp_3mb,c_ind=c_ind,c_chr=c_chr,c_posS=c_posS,c_posE=c_posE,c_cn=c_cn,c_conf=c_conf)

test=cbind(tmp_3mb,WC[,1])
colnames(test) <- c("index", "chr","chr_arm", "start", "end", "ratio_median", "size", "level", "WC")

L=dim(test)[1]

i=1
while(i + 1 < L){
  L=dim(test)[1]
  if (test[i,9] == 0 & test[i+1,9] != 1){
    test=test[-i,]}
  else{
    i=i+1}}

l=dim(test)[1]

if (is.null(l) == FALSE){ 
  if (test[l,9] == 0){ 
    while (test[l,9] == 0){
      test=test[-l,]
      l=l-1}}} 

graphe_VI_tab = test


##### Graphe different steps LGAs calling procedure #####

B <- data.frame(ratio_file_tsv)
B=B[,-1]
B=B[,-5]
colnames(B) <- c("chr", "start", "end", "readcount")
attach(B)

df=merge(aggregate(start ~ chr, B, min), aggregate(end ~ chr, B, max))[seq(from=1, to=22, by = 2),]
df=as.data.frame(df)
detach(B)


## Normalised read count

B <- data.frame(ratio_file_tsv)
B=B[,-1] 
colnames(B) <- c("chr", "start", "end", "ratio", "ratio_median")

Z <- ggplot() +
  geom_rect(data=df, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), fill = "grey85") +
  geom_point(data=B, aes(x = start, y = ratio), size=0.1, color= "black") + ggtitle(NAMEEE) +
  ylim(-2, 2) + scale_x_continuous(expand = c(0, 0)) + 
  facet_grid(~chr, scales = "free_x", space = "free_x", switch = "x") 

Z <- Z + theme(plot.title = element_text(hjust = 0.5),
               axis.title.x = element_blank(),
               axis.text.x = element_blank(),
               axis.ticks.x = element_blank(),
               axis.title.y = element_blank(),
               axis.text.y = element_text(size=20),
               panel.spacing = unit(0, "lines"),
               strip.text.x = element_blank(),
               line = element_blank(),
               panel.background = element_blank())

suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_normalised_read_count",".jpeg"), plot = Z, device = "jpeg", width = 23, height = 13))


## Part I

B <- data.frame(ratio_file_tsv)
B=B[,-1] 
colnames(B) <- c("chr", "start", "end", "ratio", "ratio_median")

C <- data.frame(graphe_I_tab)

I <- ggplot() +
  geom_rect(data=df, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), fill = "grey85") +
  geom_point(data=B, aes(x = start, y = ratio), size=0.1, color= "grey60") + ggtitle(NAMEEE) +
  geom_segment(data=C, aes(x=start, xend=end, y=ratio_median, yend=ratio_median), size = 3, color = "#990000") +
  ylim(-2, 2) + scale_x_continuous(expand = c(0, 0)) + 
  facet_grid(~chr, scales = "free_x", space = "free_x", switch = "x") 

I <- I + theme(plot.title = element_text(hjust = 0.5),
               axis.title.x = element_blank(),
               axis.text.x = element_blank(),
               axis.ticks.x = element_blank(),
               axis.title.y = element_blank(),
               axis.text.y = element_text(size=20),
               panel.spacing = unit(0, "lines"),
               strip.text.x = element_blank(),
               line = element_blank(),
               panel.background = element_blank())

suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_beginning_segmentation",".jpeg"), plot = I, device = "jpeg", width = 23, height = 13))


## true part V

graphe_V_tab = data.frame(graphe_V_tab)
graphe_V_tab$size = graphe_V_tab$end - graphe_V_tab$start + 1

copy_graphe_V_tab = graphe_V_tab
copy_graphe_V_tab = copy_graphe_V_tab[,-8]
copy_graphe_V_tab = copy_graphe_V_tab[,-7]
copy_graphe_V_tab = copy_graphe_V_tab[,-1]

write.table(copy_graphe_V_tab, file = paste0(outputPath,"/",NAMEEE,"_final_segmentation.txt"), sep = "\t", row.names = FALSE)

B <- data.frame(ratio_file_tsv)
B=B[,-1] 
colnames(B) <- c("chr", "start", "end", "ratio", "ratio_median")

C <- data.frame(graphe_V_tab)

closest_higlight = Closest(B$start, 29818156)[1]

higlight_CCNE1 = B[B$chr == 19 & B$start == closest_higlight,]

data.segm = data.frame(x=higlight_CCNE1[1,2], y=higlight_CCNE1[1,5] + 1.4, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] + 0.05, chr = 19)
data.text = data.frame(x=higlight_CCNE1[1,2], y=higlight_CCNE1[1,5] + 1.5, chr = 19, label = "CCNE1")

if (higlight_CCNE1[1,5] >= 0.5){
  data.segm = data.frame(x=higlight_CCNE1[1,2], y=1.85, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] + 0.05, chr = 19)
  data.text = data.frame(x=higlight_CCNE1[1,2], y=1.95, chr = 19, label = "CCNE1")
}  else if(higlight_CCNE1[1,5] >= 1.7) {
  data.segm = data.frame(x=higlight_CCNE1[1,2], y=1.1, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] - 0.05, chr = 19)
  data.text = data.frame(x=higlight_CCNE1[1,2], y=1, chr = 19, label = "CCNE1")
}

V <- ggplot() +
  geom_rect(data=df, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), fill = "grey85") +
  geom_point(data=B, aes(x = start, y = ratio), size=0.1, color= "grey60", na.rm=TRUE) +
  geom_segment(data=C, aes(x=start, xend=end, y=ratio_median, yend=ratio_median), size = 3, color = "#990000", na.rm = TRUE) +
  geom_segment(data=data.segm, mapping=aes(x=x, y=y, xend=xend, yend=yend), 
               arrow=arrow(unit(0.30,"cm"), angle = 20), size=0.6, color="black", inherit.aes = FALSE, na.rm=TRUE) +
  ylim(-2, 2) +   scale_x_continuous(expand = c(0, 0)) + ggtitle(NAMEEE) +
  facet_grid(~chr, scales = "free_x", space = "free_x", switch = "x") + 
  geom_text(data = data.text, mapping = aes(x = x, y = y, label = label), size = 3.3, inherit.aes = TRUE, na.rm=TRUE) +
  geom_point(data = higlight_CCNE1, aes(x=start, y=ratio_median), color = "orange", size = 2, na.rm=TRUE)


V <- V + theme(plot.title = element_text(hjust = 0.5),
               axis.title.x = element_blank(),
               axis.text.x = element_blank(),
               axis.ticks.x = element_blank(),
               axis.title.y = element_blank(),
               axis.text.y = element_text(size=15),
               panel.spacing = unit(0, "lines"),
               strip.text.x = element_blank(),
               line = element_blank(),
               panel.background = element_blank())

V = ggplotGrob(x = V)
V$layout$clip = "off"

suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_final_segmentation",".jpeg"), plot = V, device = "jpeg", width = 23, height = 13))


##  True Part VI : LGAs if called

if (sum(WC[,1]) != 0){
  
  B <- data.frame(ratio_file_tsv)
  B=B[,-1] 
  colnames(B) <- c("chr", "start", "end", "ratio", "ratio_median")
  
  C <- data.frame(graphe_VI_tab)
  graphe_VI_tab = data.frame(graphe_VI_tab)
  graphe_VI_tab$size = graphe_VI_tab$end - graphe_VI_tab$start + 1
  
  copy_graphe_VI_tab = graphe_VI_tab
  copy_graphe_VI_tab = copy_graphe_VI_tab[,-9]
  copy_graphe_VI_tab = copy_graphe_VI_tab[,-8]
  copy_graphe_VI_tab = copy_graphe_VI_tab[,-1]
  
  write.table(copy_graphe_VI_tab, file = paste0(outputPath,"/",NAMEEE,"_LGAs.txt"), sep = "\t", row.names = FALSE) 
  
  closest_higlight = Closest(B$start, 29818156)[1]
  
  higlight_CCNE1 = B[B$chr == 19 & B$start == closest_higlight,]
  
  data.segm = data.frame(x=higlight_CCNE1[1,2], y=higlight_CCNE1[1,5] + 1.4, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] + 0.05, chr = 19)
  data.text = data.frame(x=higlight_CCNE1[1,2], y=higlight_CCNE1[1,5] + 1.5, chr = 19, label = "CCNE1")
  
  if (higlight_CCNE1[1,5] >= 0.5){
    data.segm = data.frame(x=higlight_CCNE1[1,2], y=1.85, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] + 0.05, chr = 19)
    data.text = data.frame(x=higlight_CCNE1[1,2], y=1.95, chr = 19, label = "CCNE1")
  }  else if(higlight_CCNE1[1,5] >= 1.7) {
    data.segm = data.frame(x=higlight_CCNE1[1,2], y=1.1, xend=higlight_CCNE1[1,2], yend=higlight_CCNE1[1,5] - 0.05, chr = 19)
    data.text = data.frame(x=higlight_CCNE1[1,2], y=1, chr = 19, label = "CCNE1")
  }
  
  VI <- ggplot() +
    geom_rect(data=df, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), fill = "grey85") +
    geom_point(data=B, aes(x = start, y = ratio), size=0.1, color= "grey60", na.rm=TRUE) +
    geom_segment(data=C, aes(x=start, xend=end, y=ratio_median, yend=ratio_median), size = 3, color = "#006600", na.rm=TRUE) +
    geom_segment(data=data.segm, mapping=aes(x=x, y=y, xend=xend, yend=yend), 
                 arrow=arrow(unit(0.30,"cm"), angle = 20), size=0.6, color="black", inherit.aes = FALSE, na.rm=TRUE) +
    ylim(-2, 2) +   scale_x_continuous(expand = c(0, 0)) + ggtitle(NAMEEE) +
    facet_grid(~chr, scales = "free_x", space = "free_x", switch = "x") +
    geom_point(data = higlight_CCNE1, aes(x=start, y=ratio_median), color = "orange", size = 2, na.rm=TRUE) +
    geom_text(data = data.text, mapping = aes(x = x, y = y, label = label), size = 4, inherit.aes = TRUE, na.rm=TRUE)
  
  VI <- VI + theme(plot.title = element_text(hjust = 0.5),
                   axis.title.x = element_blank(),
                   axis.text.x = element_blank(),
                   axis.ticks.x = element_blank(),
                   axis.title.y = element_blank(),
                   axis.text.y = element_text(size=15),
                   panel.spacing = unit(0, "lines"),
                   strip.text.x = element_blank(),
                   line = element_blank(),
                   panel.background = element_blank())
  
  VI = ggplotGrob(x = VI)
  VI$layout$clip = "off"
  
  suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_LGAs",".jpeg"), plot = VI, device = "jpeg", width = 23, height = 13))
}


##### Quality assessement #####

X_Ratio <- ratio_file_tsv
X_I = read.table(paste0(outputPath,"/",NAMEEE, "_ratio_median_gathered.txt"), header = TRUE)

X_Ratio["ratio_new"] <- NA

l = dim(X_Ratio)[1]
j=1 # X_Ratio

L = dim(X_I)[1]
i=1 # X_I

colnames(X_Ratio) <- c("feature", "chr", "start", "end", "ratio", "ratio_median", "ratio_new")

options(show.error.messages = FALSE)

cat("on going... \n")

while (j < l + 1){
  while (i < L + 1){
    
    if (j%%20000 == 0){
      cat("on going... \n")
    }
    
    if (X_Ratio$chr[j] == X_I$chr[i]){
      if (X_Ratio$start[j] >= X_I$start[i] && X_Ratio$end[j] <= X_I$end[i]){
        X_Ratio$ratio_new[j] = X_Ratio$ratio[j] - X_I$ratio_median[i]
        j = j + 1
      }
      else if (X_Ratio$start[j] >= X_I$end[i]) {
        i = i + 1
      }
      else {
        j = j + 1
      }
    }
    
    else if (X_Ratio$chr[j] > X_I$chr[i]) {
      i = i + 1
    }
    
    else{
      j = j + 1
    }
  }
}

X_Ratio$ratio_new = abs(X_Ratio$ratio_new)

vector_ratio_new = c(na.omit(X_Ratio$ratio_new))

QC_MAD_point_corrected = mad(vector_ratio_new, constant = 1)

# median vs MAD (tat)
# QC_MAD_point_corrected
# median(vector_ratio_new)


# quality

quality = "Good"

if (QC_MAD_point_corrected > 0.50){
  quality = "Bad"
} else if (QC_MAD_point_corrected > 0.14){
  if (Threshold > 0.45){
    quality = "Bad"
  }
  else{
    quality = "Average" 
  }
} else{
  if (Threshold > 0.45){
    quality = "Average"
  }
}

if (Threshold < 0.025){
  quality = "Normal or low cellularity"
}

##### Summary figure #####
## graphe

graphe = V
if (sum(WC[,1]) != 0){
  graphe = VI
}

## Threshold

Threshold = round(Threshold, 3)

## THR (corrected)

THR = round(THR, 3)

## number LGAs

number_LGAs = sum(WC[,1])

## CCNE1 amplification

CN_plus_baseline = round(higlight_CCNE1$ratio_median/THR,3)

## CCNE1 amplification diagnostic

if (CN_plus_baseline >= 4){
  CCNE1_diag = "Amplification : not BRCAness ? (>= 4)"
} else if (CN_plus_baseline >= 3){
  CCNE1_diag = "Gain [3,4["
} else{
  CCNE1_diag = "Not informative (< 3)"
}

## BRCAness

if (number_LGAs >= 20){
  HRD = "Yes (>= 20)"
} else if (number_LGAs >= 15){
  HRD = "Borderline [15;19]"
} else{
  HRD = "No (< 15)"
}

## QC_MAD_point

QC_MAD_point_corrected = round(QC_MAD_point_corrected,3)

## Table

a = c("CNA cut-off value", "CNA cut-off corrected", "cMAD", "Number LGAs 10Mb", "CCNE1 CN to baseline", "CCNE1 evidence", "QUALITY", "HRD")
b = c(Threshold, THR, QC_MAD_point_corrected, number_LGAs, CN_plus_baseline, CCNE1_diag, quality, HRD)

A = data.frame(a,b)

colnames(A) <- NULL
row.names(A) <- NULL

testy <- qplot(1:10, 1:10, geom = "blank") + 
  theme(line = element_blank(), text = element_blank(), 
        panel.background = element_blank()) +
  annotation_custom(grob = tableGrob(A, rows = NULL, theme = ttheme_default(base_size = 14, base_colour = "black", base_family = "",
                                                                            parse = FALSE)))

## Summary figure

summary_plot <- suppressWarnings(ggarrange(graphe,
                                           ggarrange(ploty, test_ploty_CN_level, testy, labels = c("B", "C", "D"), ncol = 3, font.label = list(size = 14, face = "bold")),
                                           nrow = 2, labels = "A", font.label = list(size = 14, face = "bold")))

suppressWarnings(ggsave(paste0(outputPath,"/",NAMEEE,"_summary_plot",".jpeg"), plot = summary_plot, device = "jpeg", width = 18, height = 10.17, dpi = 300))

cat("Sample : ", NAMEEE, "\n")
cat("Quality : ", quality, "\n")
cat("Number of LGAs (> 10Mb) : ", number_LGAs, "\n")
cat("BRCAness : ", HRD, "\n")
cat("======================================================== \n")
cat("======================================================== \n")
